{"ast":null,"code":"\"use strict\";\n\nmodule.exports = function (Promise, INTERNAL) {\n  var util = require(\"./util\");\n  var errorObj = util.errorObj;\n  var isObject = util.isObject;\n  function tryConvertToPromise(obj, context) {\n    if (isObject(obj)) {\n      if (obj instanceof Promise) return obj;\n      var then = getThen(obj);\n      if (then === errorObj) {\n        if (context) context._pushContext();\n        var ret = Promise.reject(then.e);\n        if (context) context._popContext();\n        return ret;\n      } else if (typeof then === \"function\") {\n        if (isAnyBluebirdPromise(obj)) {\n          var ret = new Promise(INTERNAL);\n          obj._then(ret._fulfill, ret._reject, undefined, ret, null);\n          return ret;\n        }\n        return doThenable(obj, then, context);\n      }\n    }\n    return obj;\n  }\n  function doGetThen(obj) {\n    return obj.then;\n  }\n  function getThen(obj) {\n    try {\n      return doGetThen(obj);\n    } catch (e) {\n      errorObj.e = e;\n      return errorObj;\n    }\n  }\n  var hasProp = {}.hasOwnProperty;\n  function isAnyBluebirdPromise(obj) {\n    try {\n      return hasProp.call(obj, \"_promise0\");\n    } catch (e) {\n      return false;\n    }\n  }\n  function doThenable(x, then, context) {\n    var promise = new Promise(INTERNAL);\n    var ret = promise;\n    if (context) context._pushContext();\n    promise._captureStackTrace();\n    if (context) context._popContext();\n    var synchronous = true;\n    var result = util.tryCatch(then).call(x, resolve, reject);\n    synchronous = false;\n    if (promise && result === errorObj) {\n      promise._rejectCallback(result.e, true, true);\n      promise = null;\n    }\n    function resolve(value) {\n      if (!promise) return;\n      promise._resolveCallback(value);\n      promise = null;\n    }\n    function reject(reason) {\n      if (!promise) return;\n      promise._rejectCallback(reason, synchronous, true);\n      promise = null;\n    }\n    return ret;\n  }\n  return tryConvertToPromise;\n};","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}