import { HandlerSourceType } from '../../internal/enums';
import { BootstrapNotifier, ConverterRegistry, DesignTimeViewElementRegistry, InterfaceDesignerItemRegistry, RemoteEntriesRegistry, RequestHandlerRegistryService, ValidatorRegistry, ViewElementRegistry, } from '../../internal/services';
import { applyLocalizeMetadataFn, getConverterMetadata, getDesignTimeViewElementMetadata, getInterfaceDesignerItemMetadata, getModuleMetadata, getRequestHandlerMetadata, getValidatorMetadata, getViewElementMetadata, hasInterfaceDesignerItemMetadata, instantiate, } from '../../internal/utils';
function checkRemoteName(remoteName) {
    if (!RemoteEntriesRegistry.items.has(remoteName)) {
        throw new Error(`Remote entry with name '${remoteName}' does not exist`);
    }
}
/**
 * @internal
 */
function resistantForEach(items, callback) {
    items.forEach((item) => {
        try {
            callback(item);
        }
        catch (error) {
            console.error(error);
        }
    });
}
/**
 * @internal
 */
function registerViewElements(types) {
    resistantForEach(types, (type) => {
        const registrationConfig = getViewElementMetadata(type);
        ViewElementRegistry.validate(registrationConfig);
        ViewElementRegistry.register(registrationConfig);
    });
}
/**
 * @internal
 */
function registerInterfaceDesignerItems(types, localizeFn) {
    resistantForEach(types, (type) => {
        if (!hasInterfaceDesignerItemMetadata(type)) {
            return;
        }
        let config = getInterfaceDesignerItemMetadata(type);
        config = applyLocalizeMetadataFn(config, localizeFn);
        const viewElementMetadata = getViewElementMetadata(type);
        config.type = viewElementMetadata.type;
        InterfaceDesignerItemRegistry.validate(config);
        InterfaceDesignerItemRegistry.register(config);
    });
}
/**
 * @internal
 */
function registerDesignTimeViewElements(types) {
    resistantForEach(types, (type) => {
        const registrationConfig = getDesignTimeViewElementMetadata(type);
        DesignTimeViewElementRegistry.validate(registrationConfig);
        DesignTimeViewElementRegistry.register(registrationConfig);
    });
}
/**
 * @internal
 */
function registerValidators(types, options) {
    resistantForEach(types, (type) => {
        const metadata = getValidatorMetadata(type);
        const registrationConfig = {
            ...metadata,
            instantiate: function (injectionContext) {
                const resolveDependency = options?.resolveDependency
                    ? (token) => options.resolveDependency(token, injectionContext)
                    : null;
                return instantiate(type, resolveDependency);
            },
        };
        ValidatorRegistry.validate(registrationConfig);
        ValidatorRegistry.register(registrationConfig);
    });
}
/**
 * @internal
 */
function registerConverters(types, options) {
    resistantForEach(types, (type) => {
        const metadata = getConverterMetadata(type);
        const registrationConfig = {
            ...metadata,
            instantiate: function (injectionContext) {
                const resolveDependency = options?.resolveDependency
                    ? (token) => options.resolveDependency(token, injectionContext)
                    : null;
                return instantiate(type, resolveDependency);
            },
        };
        ConverterRegistry.register(registrationConfig);
    });
}
/**
 * @internal
 */
function registerRequestHandlers(types, options, remoteName) {
    if (options.moduleType === 'remote' && !remoteName) {
        console.error("To use request handlers, 'remoteName' parameter should be specified.");
        return;
    }
    resistantForEach(types, (type) => {
        const metadata = getRequestHandlerMetadata(type);
        let registrationConfig;
        const createHandler = (injectionContext) => {
            const resolveDependency = options?.resolveDependency
                ? (token) => options.resolveDependency(token, injectionContext)
                : null;
            return instantiate(type, resolveDependency);
        };
        if (options.moduleType === 'host') {
            registrationConfig = {
                ...metadata,
                source: { type: HandlerSourceType.Host },
                createHandler,
            };
        }
        else {
            const remote = RemoteEntriesRegistry.items.get(remoteName);
            registrationConfig = {
                ...metadata,
                source: {
                    type: HandlerSourceType.Remote,
                    packageName: remote.packageName,
                },
                createHandler,
            };
        }
        RequestHandlerRegistryService.register(registrationConfig, type);
    });
}
function bootstrapDefaultCrtModule(name, type, options) {
    try {
        const moduleDefinition = getModuleMetadata(type);
        if (moduleDefinition.viewElements) {
            registerViewElements(moduleDefinition.viewElements);
            registerInterfaceDesignerItems(moduleDefinition.viewElements, options?.localizeMetadata);
        }
        if (moduleDefinition.designTimeViewElements) {
            registerDesignTimeViewElements(moduleDefinition.designTimeViewElements);
        }
        if (moduleDefinition.requestHandlers) {
            registerRequestHandlers(moduleDefinition.requestHandlers, options, name);
        }
        if (moduleDefinition.validators) {
            registerValidators(moduleDefinition.validators, options);
        }
        if (moduleDefinition.converters) {
            registerConverters(moduleDefinition.converters, options);
        }
        moduleDefinition.includes?.forEach((t) => {
            bootstrapDefaultCrtModule(name, t, options);
            bootstrapPredefinedModules(name, t, options);
        });
    }
    catch (error) {
        console.error(error);
    }
}
/**
 * @internal
 */
function bootstrapPredefinedModules(name, type, options) {
    const modulePrefix = 'module:';
    const metadataKeys = Reflect.getOwnMetadataKeys(type);
    for (const key of metadataKeys) {
        if (typeof key === 'string' && key.startsWith(modulePrefix)) {
            const moduleType = key.substring(modulePrefix.length);
            const predefinedBootstrapper = Reflect.getOwnMetadata('moduleBootstrapper:' + moduleType, type);
            try {
                predefinedBootstrapper(name, type, options);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
}
/**
 * @internal
 */
export function bootstrapCrtModule(...args) {
    const name = typeof args[0] === 'string' ? args.shift() : undefined;
    const type = args[0];
    const options = args[1] ?? {};
    options.moduleType ?? (options.moduleType = 'remote');
    if (name) {
        if (options.moduleType === 'remote') {
            checkRemoteName(name);
        }
        else {
            throw new Error('Host module cannot have name');
        }
    }
    bootstrapDefaultCrtModule(name, type, options);
    bootstrapPredefinedModules(name, type, options);
    if (options.moduleType === 'remote') {
        BootstrapNotifier.instance.notify(type);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLWNydC1tb2R1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2RldmtpdC9jb21tb24vc3JjL2xpYi9wdWJsaWMvZnVuY3Rpb25zL2Jvb3RzdHJhcC1jcnQtbW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBU3pELE9BQU8sRUFDTixpQkFBaUIsRUFDakIsaUJBQWlCLEVBQ2pCLDZCQUE2QixFQUM3Qiw2QkFBNkIsRUFDN0IscUJBQXFCLEVBQ3JCLDZCQUE2QixFQUM3QixpQkFBaUIsRUFDakIsbUJBQW1CLEdBQ25CLE1BQU0seUJBQXlCLENBQUM7QUFFakMsT0FBTyxFQUNOLHVCQUF1QixFQUN2QixvQkFBb0IsRUFDcEIsZ0NBQWdDLEVBQ2hDLGdDQUFnQyxFQUNoQyxpQkFBaUIsRUFDakIseUJBQXlCLEVBQ3pCLG9CQUFvQixFQUNwQixzQkFBc0IsRUFDdEIsZ0NBQWdDLEVBQ2hDLFdBQVcsR0FDWCxNQUFNLHNCQUFzQixDQUFDO0FBdUI5QixTQUFTLGVBQWUsQ0FBQyxVQUFrQjtJQUMxQyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNqRCxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixVQUFVLGtCQUFrQixDQUFDLENBQUM7S0FDekU7QUFDRixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGdCQUFnQixDQUFJLEtBQWUsRUFBRSxRQUEyQjtJQUN4RSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDdEIsSUFBSTtZQUNILFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNmO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3JC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QUU7Z0JBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNyQjtTQUNEO0tBQ0Q7QUFDRixDQUFDO0FBc0JEOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGtCQUFrQixDQUFDLEdBQUcsSUFBZTtJQUNwRCxNQUFNLElBQUksR0FBdUIsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBUyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoRyxNQUFNLElBQUksR0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDM0IsTUFBTSxPQUFPLEdBQXFCLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEQsT0FBTyxDQUFDLFVBQVUsS0FBbEIsT0FBTyxDQUFDLFVBQVUsR0FBSyxRQUFRLEVBQUM7SUFDaEMsSUFBSSxJQUFJLEVBQUU7UUFDVCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3BDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN0QjthQUFNO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1NBQ2hEO0tBQ0Q7SUFDRCx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLDBCQUEwQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEQsSUFBSSxPQUFPLENBQUMsVUFBVSxLQUFLLFFBQVEsRUFBRTtRQUNwQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3hDO0FBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsaXplRm4sIFJlc29sdmVEZXBlbmRlbmN5Rm4sIFR5cGUsIEJhc2VSZXF1ZXN0IH0gZnJvbSAnLi4vLi4vYmFzZS1leHBvcnRzJztcbmltcG9ydCB7IEhhbmRsZXJTb3VyY2VUeXBlIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvZW51bXMnO1xuaW1wb3J0IHtcblx0SW5qZWN0aW9uQ29udGV4dCxcblx0SW50ZXJmYWNlRGVzaWduZXJSZWdpc3RyeUl0ZW0sXG5cdFJlbW90ZUJ1aWxkSW5mbyxcblx0UmVxdWVzdEhhbmRsZXJSZWdpc3RyYXRpb25Db25maWcsXG5cdFZhbGlkYXRvclJlZ2lzdHJ5SXRlbSxcbn0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvbW9kZWxzJztcbmltcG9ydCB7IENvbnZlcnRlclJlZ2lzdHJ5SXRlbSB9IGZyb20gJy4uLy4uL2ludGVybmFsL21vZGVscy9jb252ZXJ0ZXInO1xuaW1wb3J0IHtcblx0Qm9vdHN0cmFwTm90aWZpZXIsXG5cdENvbnZlcnRlclJlZ2lzdHJ5LFxuXHREZXNpZ25UaW1lVmlld0VsZW1lbnRSZWdpc3RyeSxcblx0SW50ZXJmYWNlRGVzaWduZXJJdGVtUmVnaXN0cnksXG5cdFJlbW90ZUVudHJpZXNSZWdpc3RyeSxcblx0UmVxdWVzdEhhbmRsZXJSZWdpc3RyeVNlcnZpY2UsXG5cdFZhbGlkYXRvclJlZ2lzdHJ5LFxuXHRWaWV3RWxlbWVudFJlZ2lzdHJ5LFxufSBmcm9tICcuLi8uLi9pbnRlcm5hbC9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBJbnRlcm5hbFJlc29sdmVEZXBlbmRlbmN5Rm4gfSBmcm9tICcuLi8uLi9pbnRlcm5hbC90eXBlcyc7XG5pbXBvcnQge1xuXHRhcHBseUxvY2FsaXplTWV0YWRhdGFGbixcblx0Z2V0Q29udmVydGVyTWV0YWRhdGEsXG5cdGdldERlc2lnblRpbWVWaWV3RWxlbWVudE1ldGFkYXRhLFxuXHRnZXRJbnRlcmZhY2VEZXNpZ25lckl0ZW1NZXRhZGF0YSxcblx0Z2V0TW9kdWxlTWV0YWRhdGEsXG5cdGdldFJlcXVlc3RIYW5kbGVyTWV0YWRhdGEsXG5cdGdldFZhbGlkYXRvck1ldGFkYXRhLFxuXHRnZXRWaWV3RWxlbWVudE1ldGFkYXRhLFxuXHRoYXNJbnRlcmZhY2VEZXNpZ25lckl0ZW1NZXRhZGF0YSxcblx0aW5zdGFudGlhdGUsXG59IGZyb20gJy4uLy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IEJhc2VSZXF1ZXN0SGFuZGxlciB9IGZyb20gJy4uLy4uL3B1YmxpYy9oYW5kbGVycyc7XG5pbXBvcnQgeyBCYXNlVmFsaWRhdG9yLCBDb252ZXJ0ZXIgfSBmcm9tICcuLi9tb2RlbHMnO1xuXG4vKipcbiAqIEBwdWJsaWNcbiAqIEBkZXNjcmlwdGlvbiBNb2R1bGUgYm9vdHN0cmFwIG9wdGlvbnNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCb290c3RyYXBPcHRpb25zIHtcblx0LyoqXG5cdCAqIEZ1bmN0aW9uIHRvIGJlIHVzZWQgdG8gdHJhbnNsYXRlIGxvY2FsaXphYmxlIHZhbHVlcyBvZiBjbGFzcyBtZXRhZGF0YVxuXHQgKi9cblx0bG9jYWxpemVNZXRhZGF0YT86IExvY2FsaXplRm47XG5cdC8qKlxuXHQgKiBGdW5jdGlvbiB0byBiZSB1c2VkIHRvIHJlc29sdmUgY2xhc3MgZGVwZW5kZW5jaWVzXG5cdCAqL1xuXHRyZXNvbHZlRGVwZW5kZW5jeT86IFJlc29sdmVEZXBlbmRlbmN5Rm47XG5cdC8qKlxuXHQgKiBAaW50ZXJuYWxcblx0ICovXG5cdG1vZHVsZVR5cGU/OiAnaG9zdCcgfCAncmVtb3RlJztcbn1cblxuZnVuY3Rpb24gY2hlY2tSZW1vdGVOYW1lKHJlbW90ZU5hbWU6IHN0cmluZyk6IHZvaWQge1xuXHRpZiAoIVJlbW90ZUVudHJpZXNSZWdpc3RyeS5pdGVtcy5oYXMocmVtb3RlTmFtZSkpIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoYFJlbW90ZSBlbnRyeSB3aXRoIG5hbWUgJyR7cmVtb3RlTmFtZX0nIGRvZXMgbm90IGV4aXN0YCk7XG5cdH1cbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZnVuY3Rpb24gcmVzaXN0YW50Rm9yRWFjaDxUPihpdGVtczogQXJyYXk8VD4sIGNhbGxiYWNrOiAoaXRlbTogVCkgPT4gdm9pZCk6IHZvaWQge1xuXHRpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNhbGxiYWNrKGl0ZW0pO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcblx0XHR9XG5cdH0pO1xufVxuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5mdW5jdGlvbiByZWdpc3RlclZpZXdFbGVtZW50cyh0eXBlczogVHlwZVtdKTogdm9pZCB7XG5cdHJlc2lzdGFudEZvckVhY2godHlwZXMsICh0eXBlKSA9PiB7XG5cdFx0Y29uc3QgcmVnaXN0cmF0aW9uQ29uZmlnID0gZ2V0Vmlld0VsZW1lbnRNZXRhZGF0YSh0eXBlKTtcblx0XHRWaWV3RWxlbWVudFJlZ2lzdHJ5LnZhbGlkYXRlKHJlZ2lzdHJhdGlvbkNvbmZpZyk7XG5cdFx0Vmlld0VsZW1lbnRSZWdpc3RyeS5yZWdpc3RlcihyZWdpc3RyYXRpb25Db25maWcpO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZnVuY3Rpb24gcmVnaXN0ZXJJbnRlcmZhY2VEZXNpZ25lckl0ZW1zKHR5cGVzOiBUeXBlW10sIGxvY2FsaXplRm4/OiBMb2NhbGl6ZUZuKTogdm9pZCB7XG5cdHJlc2lzdGFudEZvckVhY2godHlwZXMsICh0eXBlKSA9PiB7XG5cdFx0aWYgKCFoYXNJbnRlcmZhY2VEZXNpZ25lckl0ZW1NZXRhZGF0YSh0eXBlKSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRsZXQgY29uZmlnID0gZ2V0SW50ZXJmYWNlRGVzaWduZXJJdGVtTWV0YWRhdGEodHlwZSkgYXMgSW50ZXJmYWNlRGVzaWduZXJSZWdpc3RyeUl0ZW07XG5cdFx0Y29uZmlnID0gYXBwbHlMb2NhbGl6ZU1ldGFkYXRhRm4oY29uZmlnLCBsb2NhbGl6ZUZuKTtcblx0XHRjb25zdCB2aWV3RWxlbWVudE1ldGFkYXRhID0gZ2V0Vmlld0VsZW1lbnRNZXRhZGF0YSh0eXBlKTtcblx0XHRjb25maWcudHlwZSA9IHZpZXdFbGVtZW50TWV0YWRhdGEudHlwZTtcblx0XHRJbnRlcmZhY2VEZXNpZ25lckl0ZW1SZWdpc3RyeS52YWxpZGF0ZShjb25maWcpO1xuXHRcdEludGVyZmFjZURlc2lnbmVySXRlbVJlZ2lzdHJ5LnJlZ2lzdGVyKGNvbmZpZyk7XG5cdH0pO1xufVxuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5mdW5jdGlvbiByZWdpc3RlckRlc2lnblRpbWVWaWV3RWxlbWVudHModHlwZXM6IFR5cGVbXSk6IHZvaWQge1xuXHRyZXNpc3RhbnRGb3JFYWNoKHR5cGVzLCAodHlwZSkgPT4ge1xuXHRcdGNvbnN0IHJlZ2lzdHJhdGlvbkNvbmZpZyA9IGdldERlc2lnblRpbWVWaWV3RWxlbWVudE1ldGFkYXRhKHR5cGUpO1xuXHRcdERlc2lnblRpbWVWaWV3RWxlbWVudFJlZ2lzdHJ5LnZhbGlkYXRlKHJlZ2lzdHJhdGlvbkNvbmZpZyk7XG5cdFx0RGVzaWduVGltZVZpZXdFbGVtZW50UmVnaXN0cnkucmVnaXN0ZXIocmVnaXN0cmF0aW9uQ29uZmlnKTtcblx0fSk7XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmZ1bmN0aW9uIHJlZ2lzdGVyVmFsaWRhdG9ycyh0eXBlczogVHlwZTxCYXNlVmFsaWRhdG9yPltdLCBvcHRpb25zPzogQm9vdHN0cmFwT3B0aW9ucyk6IHZvaWQge1xuXHRyZXNpc3RhbnRGb3JFYWNoKHR5cGVzLCAodHlwZSkgPT4ge1xuXHRcdGNvbnN0IG1ldGFkYXRhID0gZ2V0VmFsaWRhdG9yTWV0YWRhdGEodHlwZSk7XG5cdFx0Y29uc3QgcmVnaXN0cmF0aW9uQ29uZmlnOiBWYWxpZGF0b3JSZWdpc3RyeUl0ZW0gPSB7XG5cdFx0XHQuLi5tZXRhZGF0YSxcblx0XHRcdGluc3RhbnRpYXRlOiBmdW5jdGlvbiAoaW5qZWN0aW9uQ29udGV4dD86IEluamVjdGlvbkNvbnRleHQpIHtcblx0XHRcdFx0Y29uc3QgcmVzb2x2ZURlcGVuZGVuY3kgPSBvcHRpb25zPy5yZXNvbHZlRGVwZW5kZW5jeVxuXHRcdFx0XHRcdD8gKHRva2VuKSA9PiAoPEludGVybmFsUmVzb2x2ZURlcGVuZGVuY3lGbj5vcHRpb25zLnJlc29sdmVEZXBlbmRlbmN5KSh0b2tlbiwgaW5qZWN0aW9uQ29udGV4dClcblx0XHRcdFx0XHQ6IG51bGw7XG5cdFx0XHRcdHJldHVybiBpbnN0YW50aWF0ZSh0eXBlLCA8UmVzb2x2ZURlcGVuZGVuY3lGbj5yZXNvbHZlRGVwZW5kZW5jeSk7XG5cdFx0XHR9LFxuXHRcdH07XG5cdFx0VmFsaWRhdG9yUmVnaXN0cnkudmFsaWRhdGUocmVnaXN0cmF0aW9uQ29uZmlnKTtcblx0XHRWYWxpZGF0b3JSZWdpc3RyeS5yZWdpc3RlcihyZWdpc3RyYXRpb25Db25maWcpO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZnVuY3Rpb24gcmVnaXN0ZXJDb252ZXJ0ZXJzKHR5cGVzOiBUeXBlPENvbnZlcnRlcj5bXSwgb3B0aW9ucz86IEJvb3RzdHJhcE9wdGlvbnMpOiB2b2lkIHtcblx0cmVzaXN0YW50Rm9yRWFjaCh0eXBlcywgKHR5cGUpID0+IHtcblx0XHRjb25zdCBtZXRhZGF0YSA9IGdldENvbnZlcnRlck1ldGFkYXRhKHR5cGUpO1xuXHRcdGNvbnN0IHJlZ2lzdHJhdGlvbkNvbmZpZzogQ29udmVydGVyUmVnaXN0cnlJdGVtID0ge1xuXHRcdFx0Li4ubWV0YWRhdGEsXG5cdFx0XHRpbnN0YW50aWF0ZTogZnVuY3Rpb24gKGluamVjdGlvbkNvbnRleHQ/OiBJbmplY3Rpb25Db250ZXh0KSB7XG5cdFx0XHRcdGNvbnN0IHJlc29sdmVEZXBlbmRlbmN5ID0gb3B0aW9ucz8ucmVzb2x2ZURlcGVuZGVuY3lcblx0XHRcdFx0XHQ/ICh0b2tlbikgPT4gKDxJbnRlcm5hbFJlc29sdmVEZXBlbmRlbmN5Rm4+b3B0aW9ucy5yZXNvbHZlRGVwZW5kZW5jeSkodG9rZW4sIGluamVjdGlvbkNvbnRleHQpXG5cdFx0XHRcdFx0OiBudWxsO1xuXHRcdFx0XHRyZXR1cm4gaW5zdGFudGlhdGUodHlwZSwgPFJlc29sdmVEZXBlbmRlbmN5Rm4+cmVzb2x2ZURlcGVuZGVuY3kpO1xuXHRcdFx0fSxcblx0XHR9O1xuXHRcdENvbnZlcnRlclJlZ2lzdHJ5LnJlZ2lzdGVyKHJlZ2lzdHJhdGlvbkNvbmZpZyk7XG5cdH0pO1xufVxuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5mdW5jdGlvbiByZWdpc3RlclJlcXVlc3RIYW5kbGVycyhcblx0dHlwZXM6IFR5cGU8QmFzZVJlcXVlc3RIYW5kbGVyPltdLFxuXHRvcHRpb25zOiBCb290c3RyYXBPcHRpb25zLFxuXHRyZW1vdGVOYW1lPzogc3RyaW5nLFxuKTogdm9pZCB7XG5cdGlmIChvcHRpb25zLm1vZHVsZVR5cGUgPT09ICdyZW1vdGUnICYmICFyZW1vdGVOYW1lKSB7XG5cdFx0Y29uc29sZS5lcnJvcihcIlRvIHVzZSByZXF1ZXN0IGhhbmRsZXJzLCAncmVtb3RlTmFtZScgcGFyYW1ldGVyIHNob3VsZCBiZSBzcGVjaWZpZWQuXCIpO1xuXHRcdHJldHVybjtcblx0fVxuXHRyZXNpc3RhbnRGb3JFYWNoKHR5cGVzLCAodHlwZSkgPT4ge1xuXHRcdGNvbnN0IG1ldGFkYXRhID0gZ2V0UmVxdWVzdEhhbmRsZXJNZXRhZGF0YSh0eXBlKTtcblx0XHRsZXQgcmVnaXN0cmF0aW9uQ29uZmlnOiBSZXF1ZXN0SGFuZGxlclJlZ2lzdHJhdGlvbkNvbmZpZztcblx0XHRjb25zdCBjcmVhdGVIYW5kbGVyID0gKFxuXHRcdFx0aW5qZWN0aW9uQ29udGV4dD86IEluamVjdGlvbkNvbnRleHQsXG5cdFx0KTogQmFzZVJlcXVlc3RIYW5kbGVyPEJhc2VSZXF1ZXN0PHVua25vd24+LCB1bmtub3duPiA9PiB7XG5cdFx0XHRjb25zdCByZXNvbHZlRGVwZW5kZW5jeSA9IG9wdGlvbnM/LnJlc29sdmVEZXBlbmRlbmN5XG5cdFx0XHRcdD8gKHRva2VuKSA9PiAoPEludGVybmFsUmVzb2x2ZURlcGVuZGVuY3lGbj5vcHRpb25zLnJlc29sdmVEZXBlbmRlbmN5KSh0b2tlbiwgaW5qZWN0aW9uQ29udGV4dClcblx0XHRcdFx0OiBudWxsO1xuXHRcdFx0cmV0dXJuIGluc3RhbnRpYXRlKHR5cGUsIDxSZXNvbHZlRGVwZW5kZW5jeUZuPnJlc29sdmVEZXBlbmRlbmN5KTtcblx0XHR9O1xuXHRcdGlmIChvcHRpb25zLm1vZHVsZVR5cGUgPT09ICdob3N0Jykge1xuXHRcdFx0cmVnaXN0cmF0aW9uQ29uZmlnID0ge1xuXHRcdFx0XHQuLi5tZXRhZGF0YSxcblx0XHRcdFx0c291cmNlOiB7IHR5cGU6IEhhbmRsZXJTb3VyY2VUeXBlLkhvc3QgfSxcblx0XHRcdFx0Y3JlYXRlSGFuZGxlcixcblx0XHRcdH07XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHJlbW90ZSA9IFJlbW90ZUVudHJpZXNSZWdpc3RyeS5pdGVtcy5nZXQoPHN0cmluZz5yZW1vdGVOYW1lKSBhcyBSZW1vdGVCdWlsZEluZm87XG5cdFx0XHRyZWdpc3RyYXRpb25Db25maWcgPSB7XG5cdFx0XHRcdC4uLm1ldGFkYXRhLFxuXHRcdFx0XHRzb3VyY2U6IHtcblx0XHRcdFx0XHR0eXBlOiBIYW5kbGVyU291cmNlVHlwZS5SZW1vdGUsXG5cdFx0XHRcdFx0cGFja2FnZU5hbWU6IHJlbW90ZS5wYWNrYWdlTmFtZSxcblx0XHRcdFx0fSxcblx0XHRcdFx0Y3JlYXRlSGFuZGxlcixcblx0XHRcdH07XG5cdFx0fVxuXHRcdFJlcXVlc3RIYW5kbGVyUmVnaXN0cnlTZXJ2aWNlLnJlZ2lzdGVyKHJlZ2lzdHJhdGlvbkNvbmZpZywgdHlwZSk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBib290c3RyYXBEZWZhdWx0Q3J0TW9kdWxlKG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCwgdHlwZTogVHlwZSwgb3B0aW9uczogQm9vdHN0cmFwT3B0aW9ucyk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGNvbnN0IG1vZHVsZURlZmluaXRpb24gPSBnZXRNb2R1bGVNZXRhZGF0YSh0eXBlKTtcblx0XHRpZiAobW9kdWxlRGVmaW5pdGlvbi52aWV3RWxlbWVudHMpIHtcblx0XHRcdHJlZ2lzdGVyVmlld0VsZW1lbnRzKG1vZHVsZURlZmluaXRpb24udmlld0VsZW1lbnRzKTtcblx0XHRcdHJlZ2lzdGVySW50ZXJmYWNlRGVzaWduZXJJdGVtcyhtb2R1bGVEZWZpbml0aW9uLnZpZXdFbGVtZW50cywgb3B0aW9ucz8ubG9jYWxpemVNZXRhZGF0YSk7XG5cdFx0fVxuXHRcdGlmIChtb2R1bGVEZWZpbml0aW9uLmRlc2lnblRpbWVWaWV3RWxlbWVudHMpIHtcblx0XHRcdHJlZ2lzdGVyRGVzaWduVGltZVZpZXdFbGVtZW50cyhtb2R1bGVEZWZpbml0aW9uLmRlc2lnblRpbWVWaWV3RWxlbWVudHMpO1xuXHRcdH1cblx0XHRpZiAobW9kdWxlRGVmaW5pdGlvbi5yZXF1ZXN0SGFuZGxlcnMpIHtcblx0XHRcdHJlZ2lzdGVyUmVxdWVzdEhhbmRsZXJzKG1vZHVsZURlZmluaXRpb24ucmVxdWVzdEhhbmRsZXJzLCBvcHRpb25zLCBuYW1lKTtcblx0XHR9XG5cdFx0aWYgKG1vZHVsZURlZmluaXRpb24udmFsaWRhdG9ycykge1xuXHRcdFx0cmVnaXN0ZXJWYWxpZGF0b3JzKG1vZHVsZURlZmluaXRpb24udmFsaWRhdG9ycywgb3B0aW9ucyk7XG5cdFx0fVxuXHRcdGlmIChtb2R1bGVEZWZpbml0aW9uLmNvbnZlcnRlcnMpIHtcblx0XHRcdHJlZ2lzdGVyQ29udmVydGVycyhtb2R1bGVEZWZpbml0aW9uLmNvbnZlcnRlcnMsIG9wdGlvbnMpO1xuXHRcdH1cblx0XHRtb2R1bGVEZWZpbml0aW9uLmluY2x1ZGVzPy5mb3JFYWNoKCh0KSA9PiB7XG5cdFx0XHRib290c3RyYXBEZWZhdWx0Q3J0TW9kdWxlKG5hbWUsIHQsIG9wdGlvbnMpO1xuXHRcdFx0Ym9vdHN0cmFwUHJlZGVmaW5lZE1vZHVsZXMobmFtZSwgdCwgb3B0aW9ucyk7XG5cdFx0fSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihlcnJvcik7XG5cdH1cbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZnVuY3Rpb24gYm9vdHN0cmFwUHJlZGVmaW5lZE1vZHVsZXMobmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkLCB0eXBlOiBUeXBlLCBvcHRpb25zOiBCb290c3RyYXBPcHRpb25zKTogdm9pZCB7XG5cdGNvbnN0IG1vZHVsZVByZWZpeCA9ICdtb2R1bGU6Jztcblx0Y29uc3QgbWV0YWRhdGFLZXlzOiBzdHJpbmdbXSA9IFJlZmxlY3QuZ2V0T3duTWV0YWRhdGFLZXlzKHR5cGUpO1xuXHRmb3IgKGNvbnN0IGtleSBvZiBtZXRhZGF0YUtleXMpIHtcblx0XHRpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LnN0YXJ0c1dpdGgobW9kdWxlUHJlZml4KSkge1xuXHRcdFx0Y29uc3QgbW9kdWxlVHlwZSA9IGtleS5zdWJzdHJpbmcobW9kdWxlUHJlZml4Lmxlbmd0aCk7XG5cdFx0XHRjb25zdCBwcmVkZWZpbmVkQm9vdHN0cmFwcGVyID0gUmVmbGVjdC5nZXRPd25NZXRhZGF0YSgnbW9kdWxlQm9vdHN0cmFwcGVyOicgKyBtb2R1bGVUeXBlLCB0eXBlKTtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHByZWRlZmluZWRCb290c3RyYXBwZXIobmFtZSwgdHlwZSwgb3B0aW9ucyk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJvb3RzdHJhcENydE1vZHVsZSh0eXBlOiBUeXBlLCBvcHRpb25zOiBCb290c3RyYXBPcHRpb25zICYgeyBtb2R1bGVUeXBlOiAnaG9zdCcgfSk6IHZvaWQ7XG4vKipcbiAqIEBwdWJsaWNcbiAqIEBkZXNjcmlwdGlvbiBGdW5jdGlvbiByZXF1aXJlZCB0byBib290c3RyYXBwaW5nIGVsZW1lbnRzIGRlZmluZWQgaW4gQ3J0TW9kdWxlcy5cbiAqIENhbGwgdGhpcyBmdW5jdGlvbiBhcyBzb29uIGFzIHBvc3NpYmxlIGR1cmluZyBib290c3RyYXBwaW5nIHlvdXIgYXBwbGljYXRpb24uXG4gKiBAcGFyYW0gdHlwZSAtIG1vZHVsZSB0eXBlXG4gKiBAcGFyYW0gb3B0aW9ucyAtIHtAbGluayBCb290c3RyYXBPcHRpb25zfVxuICpcbiAqIEBleGFtcGxlXG4gKiBib290c3RyYXBDcnRNb2R1bGUoQXBwTW9kdWxlKVxuICovXG5leHBvcnQgZnVuY3Rpb24gYm9vdHN0cmFwQ3J0TW9kdWxlKHJlbW90ZU5hbWU6IHN0cmluZywgdHlwZTogVHlwZSwgb3B0aW9ucz86IEJvb3RzdHJhcE9wdGlvbnMpOiB2b2lkO1xuLyoqXG4gKiBAcHVibGljXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gYm9vdHN0cmFwQ3J0TW9kdWxlKHR5cGU6IFR5cGUsIG9wdGlvbnM/OiBCb290c3RyYXBPcHRpb25zKTogdm9pZDtcbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBib290c3RyYXBDcnRNb2R1bGUoLi4uYXJnczogdW5rbm93bltdKTogdm9pZCB7XG5cdGNvbnN0IG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJyA/IDxzdHJpbmc+YXJncy5zaGlmdCgpIDogdW5kZWZpbmVkO1xuXHRjb25zdCB0eXBlID0gPFR5cGU+YXJnc1swXTtcblx0Y29uc3Qgb3B0aW9ucyA9IDxCb290c3RyYXBPcHRpb25zPmFyZ3NbMV0gPz8ge307XG5cdG9wdGlvbnMubW9kdWxlVHlwZSA/Pz0gJ3JlbW90ZSc7XG5cdGlmIChuYW1lKSB7XG5cdFx0aWYgKG9wdGlvbnMubW9kdWxlVHlwZSA9PT0gJ3JlbW90ZScpIHtcblx0XHRcdGNoZWNrUmVtb3RlTmFtZShuYW1lKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdIb3N0IG1vZHVsZSBjYW5ub3QgaGF2ZSBuYW1lJyk7XG5cdFx0fVxuXHR9XG5cdGJvb3RzdHJhcERlZmF1bHRDcnRNb2R1bGUobmFtZSwgdHlwZSwgb3B0aW9ucyk7XG5cdGJvb3RzdHJhcFByZWRlZmluZWRNb2R1bGVzKG5hbWUsIHR5cGUsIG9wdGlvbnMpO1xuXHRpZiAob3B0aW9ucy5tb2R1bGVUeXBlID09PSAncmVtb3RlJykge1xuXHRcdEJvb3RzdHJhcE5vdGlmaWVyLmluc3RhbmNlLm5vdGlmeSh0eXBlKTtcblx0fVxufVxuIl19