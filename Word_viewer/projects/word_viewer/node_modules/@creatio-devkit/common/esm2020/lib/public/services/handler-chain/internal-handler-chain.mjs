import { generateGuid, NextHandlerAlreadySpecifiedException, } from '../../../base-exports';
import { HandlersOrderComparer } from '../../../internal/utils/handlers-order-comparer';
/**
 * @internal
 * @hostPublicApi available through window.handlerChain
 */
export class InternalHandlerChain {
    constructor() {
        this._handlers = [];
        this._requestListeners = new Map();
        this._handlersCache = new Map();
        this._handlersScopesByContextId = new Map();
        /**
         * @hostPublicApi
         */
        this.handlerChain$ = {
            /**
             * @hostPublicApi
             */
            process: async (request) => {
                const handler = this._getHandler(request);
                this._requestListeners.forEach((listener) => listener?.(request));
                return handler?.handle(request);
            },
            /**
             * @hostPublicApi
             */
            register: (info) => {
                this._handlersCache.delete(info.requestType);
                this._handlers.push(info);
                return () => {
                    const index = this._handlers.indexOf(info);
                    if (index > -1) {
                        this._handlers.splice(index, 1);
                        this._handlersCache.delete(info.requestType);
                    }
                    else {
                        console.warn(`${info?.requestType} not found to unsubscribe`);
                    }
                };
            },
            /**
             * @hostPublicApi
             */
            subscribe: (callback, context) => {
                if (!callback) {
                    return () => void 0;
                }
                const listenerId = generateGuid();
                const listenerFn = (request) => {
                    if (!context || request.$context === context) {
                        callback(request);
                    }
                };
                this._requestListeners.set(listenerId, listenerFn);
                return () => this._requestListeners.delete(listenerId);
            },
        };
    }
    /**
     * @hostPublicApi
     */
    clearContextedHandlersCache(contextId) {
        const configs = this._handlersScopesByContextId.get(contextId) ?? [];
        return configs.every(({ requestType, scope }) => this._handlersCache.get(requestType)?.delete(scope));
    }
    _getHandler(request) {
        return this._hasCacheHandler(request) ? this._getCacheHandler(request) : this._buildHandlersChain(request);
    }
    _getCacheHandler(request) {
        const map = this._handlersCache.get(request.type);
        const key = this._getCacheScopesKey(request);
        return map.get(key);
    }
    _hasCacheHandler(request) {
        const map = this._handlersCache.get(request.type);
        const key = this._getCacheScopesKey(request);
        return map && map.has(key);
    }
    _getCacheScopesKey(request) {
        const injectionContextKey = this._getInjectionContext(request?.$context)?.id ?? '';
        return (request.scopes || ['']).join('_').concat(injectionContextKey);
    }
    _getInjectionContext(viewModel) {
        return (viewModel?.['_injectionContext'] ||
            (viewModel?.['parent'] && this._getInjectionContext(viewModel['parent'])));
    }
    _setContextedScopes(request, scope) {
        const injectionContext = this._getInjectionContext(request?.$context)?.id;
        const configs = this._handlersScopesByContextId.has(injectionContext)
            ? this._handlersScopesByContextId.get(injectionContext)
            : [];
        configs.push({ requestType: request.type, scope });
        this._handlersScopesByContextId.set(injectionContext, configs);
    }
    _setCacheHandler(request, handler) {
        const map = this._handlersCache.has(request.type)
            ? this._handlersCache.get(request.type)
            : new Map();
        const key = this._getCacheScopesKey(request);
        map.set(key, handler);
        if (this._getInjectionContext(request?.$context)?.id) {
            this._setContextedScopes(request, key);
        }
        this._handlersCache.set(request.type, map);
    }
    _isRequestHandler(handler) {
        return (typeof handler.handle === 'function' &&
            typeof handler.setNext === 'function');
    }
    _checkHandlerInstanceOf(handler) {
        if (!this._isRequestHandler(handler)) {
            throw new Error('Handler should implement "BaseRequestHandler"');
        }
    }
    _buildHandlersChain(request) {
        const handlers = this._handlers.filter((h) => {
            if (h.requestType !== request.type) {
                return false;
            }
            if (!h.scopes?.length) {
                return true;
            }
            return h.scopes.some((s) => request.scopes?.includes(s));
        });
        const comparer = new HandlersOrderComparer(request);
        handlers.sort((a, b) => comparer.compare(a, b));
        const handlerInstances = handlers.map((handlerConfig) => {
            const injectionContext = this._getInjectionContext(request?.$context);
            return handlerConfig.createHandler(injectionContext);
        });
        handlerInstances.forEach((handler) => this._checkHandlerInstanceOf(handler));
        this._joinHandlersInChain(handlerInstances);
        const result = handlerInstances[0];
        this._setCacheHandler(request, result);
        return result;
    }
    _joinHandlersInChain(handlers) {
        for (let index = 0; index < handlers.length - 1; index++) {
            try {
                handlers[index].setNext(handlers[index + 1]);
            }
            catch (error) {
                if (error instanceof NextHandlerAlreadySpecifiedException) {
                    throw new Error('Handler factory should return new instance of ' +
                        'BaseRequestHandler class or its subclass ' +
                        '(next handler should not be specified)');
                }
                throw error;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtaGFuZGxlci1jaGFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvZGV2a2l0L2NvbW1vbi9zcmMvbGliL3B1YmxpYy9zZXJ2aWNlcy9oYW5kbGVyLWNoYWluL2ludGVybmFsLWhhbmRsZXItY2hhaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVOLFlBQVksRUFDWixvQ0FBb0MsR0FHcEMsTUFBTSx1QkFBdUIsQ0FBQztBQUkvQixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUd4Rjs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sb0JBQW9CO0lBQWpDO1FBQ1MsY0FBUyxHQUFvQixFQUFFLENBQUM7UUFDaEMsc0JBQWlCLEdBQWdELElBQUksR0FBRyxFQUFFLENBQUM7UUFDM0UsbUJBQWMsR0FBRyxJQUFJLEdBQUcsRUFBbUQsQ0FBQztRQUM1RSwrQkFBMEIsR0FBRyxJQUFJLEdBQUcsRUFBd0MsQ0FBQztRQUVyRjs7V0FFRztRQUNJLGtCQUFhLEdBQUc7WUFDdEI7O2VBRUc7WUFDSCxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQW9CLEVBQUUsRUFBRTtnQkFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDbEUsT0FBTyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pDLENBQUM7WUFDRDs7ZUFFRztZQUNILFFBQVEsRUFBRSxDQUFDLElBQW1CLEVBQUUsRUFBRTtnQkFDakMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dC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LFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3pELElBQUk7Z0JBQ0gsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDN0M7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZixJQUFJLEtBQUssWUFBWSxvQ0FBb0MsRUFBRTtvQkFDMUQsTUFBTSxJQUFJLEtBQUssQ0FDZCxnREFBZ0Q7d0JBQy9DLDJDQUEyQzt3QkFDM0Msd0NBQXdDLENBQ3pDLENBQUM7aUJBQ0Y7Z0JBQ0QsTUFBTSxLQUFLLENBQUM7YUFDWjtTQUNEO0lBQ0YsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QmFzZVJlcXVlc3QsXG5cdGdlbmVyYXRlR3VpZCxcblx0TmV4dEhhbmRsZXJBbHJlYWR5U3BlY2lmaWVkRXhjZXB0aW9uLFxuXHRSZXF1ZXN0SGFuZGxlcixcblx0Vmlld01vZGVsQ29udGV4dCxcbn0gZnJvbSAnLi4vLi4vLi4vYmFzZS1leHBvcnRzJztcbmltcG9ydCB7IEluamVjdGlvbkNvbnRleHQgfSBmcm9tICcuLi8uLi8uLi9pbnRlcm5hbC9tb2RlbHMvaW5qZWN0aW9uLWNvbnRleHQnO1xuaW1wb3J0IHsgQ29udGV4ZWRIYW5kbGVyU2NvcGVDb25maWcgfSBmcm9tICcuLi8uLi8uLi9pbnRlcm5hbC9tb2RlbHMvcmVxdWVzdC1oYW5kbGVyL2NvbnRleGVkLWhhbmRsZXItc2NvcGUtY29uZmlnJztcbmltcG9ydCB7IEhhbmRsZXJDb25maWcgfSBmcm9tICcuLi8uLi8uLi9pbnRlcm5hbC9tb2RlbHMvcmVxdWVzdC1oYW5kbGVyL2hhbmRsZXItY29uZmlnJztcbmltcG9ydCB7IEhhbmRsZXJzT3JkZXJDb21wYXJlciB9IGZyb20gJy4uLy4uLy4uL2ludGVybmFsL3V0aWxzL2hhbmRsZXJzLW9yZGVyLWNvbXBhcmVyJztcbmltcG9ydCB7IFRlYXJkb3duTG9naWMgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbi8qKlxuICogQGludGVybmFsXG4gKiBAaG9zdFB1YmxpY0FwaSBhdmFpbGFibGUgdGhyb3VnaCB3aW5kb3cuaGFuZGxlckNoYWluXG4gKi9cbmV4cG9ydCBjbGFzcyBJbnRlcm5hbEhhbmRsZXJDaGFpbiB7XG5cdHByaXZhdGUgX2hhbmRsZXJzOiBIYW5kbGVyQ29uZmlnW10gPSBbXTtcblx0cHJpdmF0ZSBfcmVxdWVzdExpc3RlbmVyczogTWFwPHN0cmluZywgKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KSA9PiB2b2lkPiA9IG5ldyBNYXAoKTtcblx0cHJpdmF0ZSBfaGFuZGxlcnNDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBSZXF1ZXN0SGFuZGxlciB8IHVuZGVmaW5lZD4+KCk7XG5cdHByaXZhdGUgX2hhbmRsZXJzU2NvcGVzQnlDb250ZXh0SWQgPSBuZXcgTWFwPHN0cmluZywgQ29udGV4ZWRIYW5kbGVyU2NvcGVDb25maWdbXT4oKTtcblxuXHQvKipcblx0ICogQGhvc3RQdWJsaWNBcGlcblx0ICovXG5cdHB1YmxpYyBoYW5kbGVyQ2hhaW4kID0ge1xuXHRcdC8qKlxuXHRcdCAqIEBob3N0UHVibGljQXBpXG5cdFx0ICovXG5cdFx0cHJvY2VzczogYXN5bmMgKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KSA9PiB7XG5cdFx0XHRjb25zdCBoYW5kbGVyID0gdGhpcy5fZ2V0SGFuZGxlcihyZXF1ZXN0KTtcblx0XHRcdHRoaXMuX3JlcXVlc3RMaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIpID0+IGxpc3RlbmVyPy4ocmVxdWVzdCkpO1xuXHRcdFx0cmV0dXJuIGhhbmRsZXI/LmhhbmRsZShyZXF1ZXN0KTtcblx0XHR9LFxuXHRcdC8qKlxuXHRcdCAqIEBob3N0UHVibGljQXBpXG5cdFx0ICovXG5cdFx0cmVnaXN0ZXI6IChpbmZvOiBIYW5kbGVyQ29uZmlnKSA9PiB7XG5cdFx0XHR0aGlzLl9oYW5kbGVyc0NhY2hlLmRlbGV0ZShpbmZvLnJlcXVlc3RUeXBlKTtcblx0XHRcdHRoaXMuX2hhbmRsZXJzLnB1c2goaW5mbyk7XG5cdFx0XHRyZXR1cm4gKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBpbmRleCA9IHRoaXMuX2hhbmRsZXJzLmluZGV4T2YoaW5mbyk7XG5cdFx0XHRcdGlmIChpbmRleCA+IC0xKSB7XG5cdFx0XHRcdFx0dGhpcy5faGFuZGxlcnMuc3BsaWNlKGluZGV4LCAxKTtcblx0XHRcdFx0XHR0aGlzLl9oYW5kbGVyc0NhY2hlLmRlbGV0ZShpbmZvLnJlcXVlc3RUeXBlKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zb2xlLndhcm4oYCR7aW5mbz8ucmVxdWVzdFR5cGV9IG5vdCBmb3VuZCB0byB1bnN1YnNjcmliZWApO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXHRcdH0sXG5cdFx0LyoqXG5cdFx0ICogQGhvc3RQdWJsaWNBcGlcblx0XHQgKi9cblx0XHRzdWJzY3JpYmU6IChjYWxsYmFjazogKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KSA9PiB2b2lkLCBjb250ZXh0PzogVmlld01vZGVsQ29udGV4dCk6IFRlYXJkb3duTG9naWMgPT4ge1xuXHRcdFx0aWYgKCFjYWxsYmFjaykge1xuXHRcdFx0XHRyZXR1cm4gKCkgPT4gdm9pZCAwO1xuXHRcdFx0fVxuXHRcdFx0Y29uc3QgbGlzdGVuZXJJZCA9IGdlbmVyYXRlR3VpZCgpO1xuXHRcdFx0Y29uc3QgbGlzdGVuZXJGbjogKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KSA9PiB2b2lkID0gKHJlcXVlc3QpID0+IHtcblx0XHRcdFx0aWYgKCFjb250ZXh0IHx8IHJlcXVlc3QuJGNvbnRleHQgPT09IGNvbnRleHQpIHtcblx0XHRcdFx0XHRjYWxsYmFjayhyZXF1ZXN0KTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblx0XHRcdHRoaXMuX3JlcXVlc3RMaXN0ZW5lcnMuc2V0KGxpc3RlbmVySWQsIGxpc3RlbmVyRm4pO1xuXHRcdFx0cmV0dXJuICgpID0+IHRoaXMuX3JlcXVlc3RMaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVySWQpO1xuXHRcdH0sXG5cdH07XG5cblx0LyoqXG5cdCAqIEBob3N0UHVibGljQXBpXG5cdCAqL1xuXHRwdWJsaWMgY2xlYXJDb250ZXh0ZWRIYW5kbGVyc0NhY2hlKGNvbnRleHRJZDogc3RyaW5nKTogYm9vbGVhbiB7XG5cdFx0Y29uc3QgY29uZmlnczogQ29udGV4ZWRIYW5kbGVyU2NvcGVDb25maWdbXSA9IHRoaXMuX2hhbmRsZXJzU2NvcGVzQnlDb250ZXh0SWQuZ2V0KGNvbnRleHRJZCkgPz8gW107XG5cdFx0cmV0dXJuIGNvbmZpZ3MuZXZlcnkoKHsgcmVxdWVzdFR5cGUsIHNjb3BlIH0pID0+IHRoaXMuX2hhbmRsZXJzQ2FjaGUuZ2V0KHJlcXVlc3RUeXBlKT8uZGVsZXRlKHNjb3BlKSk7XG5cdH1cblxuXHRwcml2YXRlIF9nZXRIYW5kbGVyKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KTogUmVxdWVzdEhhbmRsZXIgfCB1bmRlZmluZWQge1xuXHRcdHJldHVybiB0aGlzLl9oYXNDYWNoZUhhbmRsZXIocmVxdWVzdCkgPyB0aGlzLl9nZXRDYWNoZUhhbmRsZXIocmVxdWVzdCkgOiB0aGlzLl9idWlsZEhhbmRsZXJzQ2hhaW4ocmVxdWVzdCk7XG5cdH1cblxuXHRwcml2YXRlIF9nZXRDYWNoZUhhbmRsZXIocmVxdWVzdDogQmFzZVJlcXVlc3QpOiBSZXF1ZXN0SGFuZGxlciB8IHVuZGVmaW5lZCB7XG5cdFx0Y29uc3QgbWFwID0gdGhpcy5faGFuZGxlcnNDYWNoZS5nZXQocmVxdWVzdC50eXBlKSBhcyBNYXA8c3RyaW5nLCBSZXF1ZXN0SGFuZGxlciB8IHVuZGVmaW5lZD47XG5cdFx0Y29uc3Qga2V5ID0gdGhpcy5fZ2V0Q2FjaGVTY29wZXNLZXkocmVxdWVzdCk7XG5cdFx0cmV0dXJuIG1hcC5nZXQoa2V5KTtcblx0fVxuXG5cdHByaXZhdGUgX2hhc0NhY2hlSGFuZGxlcihyZXF1ZXN0OiBCYXNlUmVxdWVzdCk6IGJvb2xlYW4ge1xuXHRcdGNvbnN0IG1hcCA9IHRoaXMuX2hhbmRsZXJzQ2FjaGUuZ2V0KHJlcXVlc3QudHlwZSkgYXMgTWFwPHN0cmluZywgUmVxdWVzdEhhbmRsZXIgfCB1bmRlZmluZWQ+O1xuXHRcdGNvbnN0IGtleSA9IHRoaXMuX2dldENhY2hlU2NvcGVzS2V5KHJlcXVlc3QpO1xuXHRcdHJldHVybiBtYXAgJiYgbWFwLmhhcyhrZXkpO1xuXHR9XG5cblx0cHJpdmF0ZSBfZ2V0Q2FjaGVTY29wZXNLZXkocmVxdWVzdDogQmFzZVJlcXVlc3QpOiBzdHJpbmcge1xuXHRcdGNvbnN0IGluamVjdGlvbkNvbnRleHRLZXkgPSB0aGlzLl9nZXRJbmplY3Rpb25Db250ZXh0KHJlcXVlc3Q/LiRjb250ZXh0KT8uaWQgPz8gJyc7XG5cdFx0cmV0dXJuIChyZXF1ZXN0LnNjb3BlcyB8fCBbJyddKS5qb2luKCdfJykuY29uY2F0KGluamVjdGlvbkNvbnRleHRLZXkpO1xuXHR9XG5cblx0cHJpdmF0ZSBfZ2V0SW5qZWN0aW9uQ29udGV4dCh2aWV3TW9kZWw/OiBWaWV3TW9kZWxDb250ZXh0KTogSW5qZWN0aW9uQ29udGV4dCB7XG5cdFx0cmV0dXJuIChcblx0XHRcdHZpZXdNb2RlbD8uWydfaW5qZWN0aW9uQ29udGV4dCddIHx8XG5cdFx0XHQodmlld01vZGVsPy5bJ3BhcmVudCddICYmIHRoaXMuX2dldEluamVjdGlvbkNvbnRleHQodmlld01vZGVsWydwYXJlbnQnXSkpXG5cdFx0KTtcblx0fVxuXG5cdHByaXZhdGUgX3NldENvbnRleHRlZFNjb3BlcyhyZXF1ZXN0OiBCYXNlUmVxdWVzdCwgc2NvcGU6IHN0cmluZyk6IHZvaWQge1xuXHRcdGNvbnN0IGluamVjdGlvbkNvbnRleHQgPSB0aGlzLl9nZXRJbmplY3Rpb25Db250ZXh0KHJlcXVlc3Q/LiRjb250ZXh0KT8uaWQ7XG5cdFx0Y29uc3QgY29uZmlncyA9IHRoaXMuX2hhbmRsZXJzU2NvcGVzQnlDb250ZXh0SWQuaGFzKGluamVjdGlvbkNvbnRleHQpXG5cdFx0XHQ/ICh0aGlzLl9oYW5kbGVyc1Njb3Blc0J5Q29udGV4dElkLmdldChpbmplY3Rpb25Db250ZXh0KSBhcyBDb250ZXhlZEhhbmRsZXJTY29wZUNvbmZpZ1tdKVxuXHRcdFx0OiBbXTtcblx0XHRjb25maWdzLnB1c2goeyByZXF1ZXN0VHlwZTogcmVxdWVzdC50eXBlLCBzY29wZSB9KTtcblx0XHR0aGlzLl9oYW5kbGVyc1Njb3Blc0J5Q29udGV4dElkLnNldChpbmplY3Rpb25Db250ZXh0LCBjb25maWdzKTtcblx0fVxuXG5cdHByaXZhdGUgX3NldENhY2hlSGFuZGxlcihyZXF1ZXN0OiBCYXNlUmVxdWVzdCwgaGFuZGxlcjogUmVxdWVzdEhhbmRsZXIgfCB1bmRlZmluZWQpOiB2b2lkIHtcblx0XHRjb25zdCBtYXAgPSB0aGlzLl9oYW5kbGVyc0NhY2hlLmhhcyhyZXF1ZXN0LnR5cGUpXG5cdFx0XHQ/ICh0aGlzLl9oYW5kbGVyc0NhY2hlLmdldChyZXF1ZXN0LnR5cGUpIGFzIE1hcDxzdHJpbmcsIFJlcXVlc3RIYW5kbGVyIHwgdW5kZWZpbmVkPilcblx0XHRcdDogbmV3IE1hcCgpO1xuXHRcdGNvbnN0IGtleSA9IHRoaXMuX2dldENhY2hlU2NvcGVzS2V5KHJlcXVlc3QpO1xuXHRcdG1hcC5zZXQoa2V5LCBoYW5kbGVyKTtcblx0XHRpZiAodGhpcy5fZ2V0SW5qZWN0aW9uQ29udGV4dChyZXF1ZXN0Py4kY29udGV4dCk/LmlkKSB7XG5cdFx0XHR0aGlzLl9zZXRDb250ZXh0ZWRTY29wZXMocmVxdWVzdCwga2V5KTtcblx0XHR9XG5cdFx0dGhpcy5faGFuZGxlcnNDYWNoZS5zZXQocmVxdWVzdC50eXBlLCBtYXApO1xuXHR9XG5cblx0cHJpdmF0ZSBfaXNSZXF1ZXN0SGFuZGxlcihoYW5kbGVyOiB1bmtub3duKTogaGFuZGxlciBpcyBSZXF1ZXN0SGFuZGxlciB7XG5cdFx0cmV0dXJuIChcblx0XHRcdHR5cGVvZiAoaGFuZGxlciBhcyBSZXF1ZXN0SGFuZGxlcikuaGFuZGxlID09PSAnZnVuY3Rpb24nICYmXG5cdFx0XHR0eXBlb2YgKGhhbmRsZXIgYXMgUmVxdWVzdEhhbmRsZXIpLnNldE5leHQgPT09ICdmdW5jdGlvbidcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBfY2hlY2tIYW5kbGVySW5zdGFuY2VPZihoYW5kbGVyOiB1bmtub3duKTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLl9pc1JlcXVlc3RIYW5kbGVyKGhhbmRsZXIpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZXIgc2hvdWxkIGltcGxlbWVudCBcIkJhc2VSZXF1ZXN0SGFuZGxlclwiJyk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBfYnVpbGRIYW5kbGVyc0NoYWluKHJlcXVlc3Q6IEJhc2VSZXF1ZXN0KTogUmVxdWVzdEhhbmRsZXIgfCB1bmRlZmluZWQge1xuXHRcdGNvbnN0IGhhbmRsZXJzID0gdGhpcy5faGFuZGxlcnMuZmlsdGVyKChoKSA9PiB7XG5cdFx0XHRpZiAoaC5yZXF1ZXN0VHlwZSAhPT0gcmVxdWVzdC50eXBlKSB7XG5cdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdH1cblx0XHRcdGlmICghaC5zY29wZXM/Lmxlbmd0aCkge1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblx0XHRcdHJldHVybiBoLnNjb3Blcy5zb21lKChzKSA9PiByZXF1ZXN0LnNjb3Blcz8uaW5jbHVkZXMocykpO1xuXHRcdH0pO1xuXHRcdGNvbnN0IGNvbXBhcmVyID0gbmV3IEhhbmRsZXJzT3JkZXJDb21wYXJlcihyZXF1ZXN0KTtcblx0XHRoYW5kbGVycy5zb3J0KChhLCBiKSA9PiBjb21wYXJlci5jb21wYXJlKGEsIGIpKTtcblx0XHRjb25zdCBoYW5kbGVySW5zdGFuY2VzID0gaGFuZGxlcnMubWFwKChoYW5kbGVyQ29uZmlnKSA9PiB7XG5cdFx0XHRjb25zdCBpbmplY3Rpb25Db250ZXh0ID0gdGhpcy5fZ2V0SW5qZWN0aW9uQ29udGV4dChyZXF1ZXN0Py4kY29udGV4dCk7XG5cdFx0XHRyZXR1cm4gaGFuZGxlckNvbmZpZy5jcmVhdGVIYW5kbGVyKGluamVjdGlvbkNvbnRleHQpO1xuXHRcdH0pO1xuXHRcdGhhbmRsZXJJbnN0YW5jZXMuZm9yRWFjaCgoaGFuZGxlcikgPT4gdGhpcy5fY2hlY2tIYW5kbGVySW5zdGFuY2VPZihoYW5kbGVyKSk7XG5cdFx0dGhpcy5fam9pbkhhbmRsZXJzSW5DaGFpbihoYW5kbGVySW5zdGFuY2VzKTtcblx0XHRjb25zdCByZXN1bHQgPSBoYW5kbGVySW5zdGFuY2VzWzBdO1xuXHRcdHRoaXMuX3NldENhY2hlSGFuZGxlcihyZXF1ZXN0LCByZXN1bHQpO1xuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRwcml2YXRlIF9qb2luSGFuZGxlcnNJbkNoYWluKGhhbmRsZXJzOiBSZXF1ZXN0SGFuZGxlcltdKTogdm9pZCB7XG5cdFx0Zm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGhhbmRsZXJzLmxlbmd0aCAtIDE7IGluZGV4KyspIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGhhbmRsZXJzW2luZGV4XS5zZXROZXh0KGhhbmRsZXJzW2luZGV4ICsgMV0pO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0aWYgKGVycm9yIGluc3RhbmNlb2YgTmV4dEhhbmRsZXJBbHJlYWR5U3BlY2lmaWVkRXhjZXB0aW9uKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0J0hhbmRsZXIgZmFjdG9yeSBzaG91bGQgcmV0dXJuIG5ldyBpbnN0YW5jZSBvZiAnICtcblx0XHRcdFx0XHRcdFx0J0Jhc2VSZXF1ZXN0SGFuZGxlciBjbGFzcyBvciBpdHMgc3ViY2xhc3MgJyArXG5cdFx0XHRcdFx0XHRcdCcobmV4dCBoYW5kbGVyIHNob3VsZCBub3QgYmUgc3BlY2lmaWVkKScsXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXHRcdFx0XHR0aHJvdyBlcnJvcjtcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cbiJdfQ==